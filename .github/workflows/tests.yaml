name: Test AIAS

on: push

jobs:
  hadolint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      - name: Run Hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: "Dockerfile-airs"


  dockle:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Build Docker images
        run: ./release/build_docker_images.sh tests

      - name: Install Dockle
        run: |
          VERSION=$(curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          curl -L -o dockle https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit
          chmod +x dockle

      - name: Run Dockle agate
        run: ./dockle --exit-level WARN -af settings.py gisaia/agate:tests
      - name: Run Dockle agate
        run: ./dockle -af settings.py gisaia/airs:tests
      - name: Run Dockle agate
        run: ./dockle -af settings.py gisaia/fam:tests      
      - name: Run Dockle agate
        run: ./dockle -af settings.py -i CIS-DI-0009 -i DKL-DI-0005 gisaia/aproc-proc:tests
      - name: Run Dockle agate
        run: ./dockle -af settings.py gisaia/aproc-service:tests
      - name: Run Dockle agate
        run: ./dockle -af settings.py --accept-key KEY_SHA512 gisaia/arlas-fam-wui:tests
      - name: Run Dockle agate
        run: ./dockle -af settings.py gisaia/stac-geodes:tests

  aias-tests:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.1.4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    - name: Install test/requirements
      run: |
        pip install -r test/requirements.txt
    - name: Run  tests
      run: test/tests.sh

  geodes-stac-test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4.1.4
    - uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    - name: Install requirements-stac.txt
      run: |
        pip install -r requirements-stac.txt
    - name: Run  tests
      run: test/test_geodes_stac.sh

  